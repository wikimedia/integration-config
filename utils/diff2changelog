#!/bin/bash
#
# diffrecursive2changelog: generate a changelog from a diff
#
# Reads from stdin the output of `diff --recursive --quiet` and processes it to
# show a changelog suitable for changes made to JJB jobs.
#
# Example
#
#  $ diff --recursive --brief ./output-parent ./output-proposed \
#    | ./utils/diff2changelog
#  Affected jobs:
#   - beta-scap-sync-world
#  Deleted jobs:
#   - beta-code-update-eqiad
#   - beta-update-databases-eqiad
#  New jobs:
#   - beta-code-update
#  $
#

set -eu -o pipefail

pgm="$(basename "$0")"

if [[ -n "${FORCE_COLOR:-}" || -t 1 ]]; then
    BLACK_BOLD='\e[0;1m'
    YELLOW='\e[33m'
    MAGENTA='\e[35m'
    CYAN='\e[36m'
    RESET='\e[0;0m'
else
    BLACK_BOLD=
    YELLOW=
    MAGENTA=
    CYAN=
    RESET=
fi

sort | while IFS= read -r line
do
    if [[ "$line" =~ ^Files\ \./output-parent/([^/]+)/config.xml\ and\ .* ]]; then
        if [[ ! -v affected_header_written ]]; then
            printf "%sAffected jobs:%s\n" "$BLACK_BOLD" "$RESET"
            affected_header_written=1
        fi
        printf " - %s%s%s\n" "$YELLOW" "${BASH_REMATCH[1]}" "$RESET"

    elif [[ "$line" =~ ^Only\ in\ ./output-parent:\ (.+) ]]; then
        if [[ ! -v deleted_header_written ]]; then
            printf "%sDeleted jobs:%s\n" "$BLACK_BOLD" "$RESET"
            deleted_header_written=1
        fi
        printf " - %s%s%s\n" "$MAGENTA" "${BASH_REMATCH[1]}" "$RESET"

    elif [[ "$line" =~ ^Only\ in\ \./output-proposed:\ (.*) ]]; then
        if [[ ! -v new_header_written ]]; then
            printf "%sNew jobs:%s\n" "$BLACK_BOLD" "$RESET"
            new_header_written=1
        fi
        printf " - %s%s%s\n" "$CYAN" "${BASH_REMATCH[1]}" "$RESET"
    else
        >&2 printf "%s: unrecognized line: %s\n" "$pgm" "$line"
        if [ "$line" == "---" ]; then
            >&2 printf "%s: must invoke 'diff --recursive' with '--brief'\n" "$pgm"
        fi
        exit 2
    fi
done
