- publisher:
    name: email-wikidata-ci-status
    publishers:
     - email-ext:
         recipients: wikidata-ci-status@wikimedia.de
         attach-build-log: true
         first-failure: true
         aborted: true
         failure: false
         fixed: true

- publisher:
    name: email-wikimedia-discovery
    publishers:
        - email-ext:
            recipients:   'discovery-alerts@lists.wikimedia.org'
            reply-to:     'discovery-alerts@lists.wikimedia.org'
            always:       true
            content-type: text
            subject:      Update on build $BUILD_TAG
            body:         |
                          The build $BUILD_NUMBER for $ZUUL_PROJECT has finished.
                          See $BUILD_URL for details.

- project:
    name: wikidata-query-blazegraph
    jobs:
      - '{name}-maven-java8-docker':
          timeout: 180  # Blazegraph tests are long

- project:
    name: analytics-wmde-toolkit-analyzer
    jobs:
        - '{name}-maven-java8-docker':
              pom: analyzer/pom.xml
        - '{name}-maven-java8-docker-site-publish':
              pom: analyzer/pom.xml
              site_dir: src/analyzer/target/staging

- project:
    name: wikibase-daily-npm-audit
    repository: mediawiki/extensions/Wikibase
    jobs:
     - '{name}-daily-node14-npmaudit-docker':
#        recipients:
#         - email-wikidata-ci-status

- project:
    name: wikidata-query-rdf
    release-project: wikidata/query/rdf
    release-branch: master
    publishers:
        - email-wikimedia-discovery
        - castor-save-workspace-cache
        - docker-cleanup

    jobs:
     - '{name}-maven-java8-docker'
     - '{name}-maven-java8-docker-site-publish'
     - '{name}-maven-release-docker':
         timeout: 240  # minutes

- project:
      name: wikidata-query-flink-swift-plugin
      release-project: wikidata/query/flink-swift-plugin
      release-branch: master
      publishers:
          - email-wikimedia-discovery
          - castor-save-workspace-cache
          - docker-cleanup

      jobs:
          - '{name}-maven-java8-docker'
          - '{name}-maven-java8-docker-site-publish'
          - '{name}-maven-release-docker'

- job:
    name: wikidata-query-gui-build
    node: Docker
    concurrent: false
    parameters:
      # Zuul parameters for Castor
      - string:
          name: 'ZUUL_BRANCH'
          default: 'master'
      - string:
          name: 'ZUUL_PROJECT'
          default: 'wikidata/query/gui'
      - string:
          name: 'ZUUL_PIPELINE'
          default: 'postmerge'
      - string:
          name: 'ZUUL_URL'
          default: 'https://gerrit.wikimedia.org/r'
      - string:
          name: 'ZUUL_REF'
          default: 'master'
    builders:
        - docker-log-dir
        - docker-src-dir
        - docker-cache-dir
        - docker-ci-src-setup-simple
        - docker-wipe-dir:
            dir: src/build
        - docker-run-with-log-cache-src:
            image: docker-registry.wikimedia.org/releng/node14-test-browser:0.0.2-s4
            entrypoint: /run-with-xvfb.sh
            args: 'test'
        - shell: |
            export GIT_AUTHOR_NAME=WDQSGuiBuilder
            export GIT_COMMITTER_NAME=WDQSGuiBuilder
            export GIT_AUTHOR_EMAIL=wdqs-gui-build@lists.wikimedia.org
            export GIT_COMMITTER_EMAIL=wdqs-gui-build@lists.wikimedia.org

            # We do not know Gerrit SSH host fingerprint
            mkdir -p ~/.ssh
            printf 'Host gerrit.wikimedia.org\n  StrictHostKeyChecking no\n  User wdqsguibuilder\n' >> ~/.ssh/config

            git clone "ssh://wdqsguibuilder@gerrit.wikimedia.org:29418/wikidata/query/gui-deploy" ./src/build
            scp -p -P 29418 wdqsguibuilder@gerrit.wikimedia.org:hooks/commit-msg "./src/build/.git/hooks/"
            git -C ./src/build config user.name "WDQSGuiBuilder"
            git -C ./src/build config user.email "wdqs-gui-build@lists.wikimedia.org"

            # Empty the build dir (excluding sites, .git, and BC for config), preparing for the new build
            find ./src/build/ -maxdepth 1 \
                ! -wholename "./src/build/" \
                ! -wholename "./src/build/sites" \
                ! -wholename "./src/build/custom-config.json" \
                ! -wholename "./src/build/.git*" \
                -exec rm -r {} +
        - docker-run-with-log-cache-src:
            image: docker-registry.wikimedia.org/releng/node14-test-browser:0.0.2-s4
            args: 'grunt only_build'
        - shell: |
            # Make and push a commit to the repo on Gerrit
            lastrev=$(git -C ./src rev-parse HEAD)
            message=$(git -C ./src log -1 --pretty=%B | grep -v Change-Id)
            git -C ./src/build add -A
            git -C ./src/build commit -m "Merging from ${lastrev}" -m "${message}"
            git -C ./src/build push origin HEAD:refs/for/production%ready
    wrappers:
      - timeout:
          timeout: 15 # minutes
      - timestamps
      - ssh-agent-credentials:
          users:
            - 'wdqsguibuilder'
    publishers:
        - archive-log-allow-empty
        - docker-cleanup

- job:
    name: wikidata-query-builder-build
    node: Docker
    concurrent: false
    parameters:
        # Zuul parameters for Castor
        - string:
            name: 'ZUUL_BRANCH'
            default: 'master'
        - string:
            name: 'ZUUL_PROJECT'
            default: 'wikidata/query-builder'
        - string:
            name: 'ZUUL_PIPELINE'
            default: 'postmerge'
        - string:
            name: 'ZUUL_URL'
            default: 'https://gerrit.wikimedia.org/r'
        - string:
            name: 'ZUUL_REF'
            default: 'master'
    builders:
        - docker-log-dir
        - docker-src-dir
        - docker-cache-dir
        - docker-ci-src-setup-simple
        - docker-wipe-dir:
            dir: dist
        - docker-run-with-log-cache-src:
            image: docker-registry.wikimedia.org/releng/node14-test-browser:0.0.2-s4
            entrypoint: /run-with-xvfb.sh
            args: 'test'
        - shell: |
            export GIT_AUTHOR_NAME=WDQSGuiBuilder
            export GIT_COMMITTER_NAME=WDQSGuiBuilder
            export GIT_AUTHOR_EMAIL=wdqs-gui-build@lists.wikimedia.org
            export GIT_COMMITTER_EMAIL=wdqs-gui-build@lists.wikimedia.org

            # We do not know Gerrit SSH host fingerprint
            mkdir -p ~/.ssh
            printf 'Host gerrit.wikimedia.org\n  StrictHostKeyChecking no\n  User wdqsguibuilder\n' >> ~/.ssh/config

            git clone -b production "ssh://wdqsguibuilder@gerrit.wikimedia.org:29418/wikidata/query-builder/deploy" ./src/dist-deploy
            scp -p -P 29418 wdqsguibuilder@gerrit.wikimedia.org:hooks/commit-msg "./src/dist-deploy/.git/hooks/"
            git -C ./src/dist-deploy config user.name "WDQSGuiBuilder"
            git -C ./src/dist-deploy config user.email "wdqs-gui-build@lists.wikimedia.org"

            # Empty the build dir (excluding .git), preparing for the new build
            find ./src/dist-deploy/ -maxdepth 1 ! -wholename "./src/dist-deploy/" ! -wholename "./src/dist-deploy/.git" -exec rm -r {} +
        - docker-run-with-log-cache-src:
            image: docker-registry.wikimedia.org/releng/node14-test-browser:0.0.2-s4
            args: 'build'
        - shell: |
            # Copy the build result
            cp -R ./src/dist/* ./src/dist-deploy/
            # Make and push a commit to the repo on Gerrit
            lastrev=$(git -C ./src rev-parse HEAD)
            message=$(git -C ./src log -1 --pretty=%B | grep -v Change-Id)
            git -C ./src/dist-deploy add -A
            git -C ./src/dist-deploy commit -m "Merging from ${lastrev}" -m "${message}"
            git -C ./src/dist-deploy push origin HEAD:refs/for/production%ready
    wrappers:
        - timeout:
            timeout: 15 # minutes
        - timestamps
        - ssh-agent-credentials:
            users:
            - 'wdqsguibuilder'
    publishers:
        - archive-log-allow-empty
        - docker-cleanup
- project:
    name: wikidata-quibble-daily-notgated
    # Wikidata extensions that are not part of gate
    project:
        # The commented out ones are because of T285049#7311916
        # - ArticlePlaceholder
        - Cognate
        - InterwikiSorting
        # - WikibaseLexeme
        # - WikibaseManifest
        # - WikibaseQualityConstraints
        # - Wikidata.org
    jobs:
        - quibble-daily-{project}-{packages-source}-{database}-{php}-docker:
            database: mysql
            php:
                - php72:
                    docker_image: docker-registry.wikimedia.org/releng/quibble-buster-php72:1.4.5
                    entrypoint: quibble-with-supervisord
            packages-source: vendor
