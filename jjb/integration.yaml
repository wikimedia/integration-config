# Jobs for integration/*

# Parameter:
# entrypoint: script to run. Relative to integration/config root dir
- job-template:
    name: 'integration-config-{command}-docker'
    node: Docker
    triggers:
        - zuul
    builders:
        - docker-castor-load
        - docker-log-dir
        # we need a full clone
        - docker-zuul-cloner:
            projects: >
                integration/config
        - docker-run-with-log-cache-src:
            image: docker-registry.wikimedia.org/releng/tox-buster:4.8.0-1
            entrypoint: '/src/integration/config/{entrypoint}'
            workdir: /src/integration/config
    publishers:
        - castor-save-workspace-cache
        - docker-cleanup
    wrappers:
      - timeout:
          timeout: '{timeout|30}'
          fail: true
      - timestamps
      - credentials-binding:
          - text:
              credential-id: composer-github-oauthtoken
              variable: COMPOSER_GITHUB_OAUTHTOKEN
          - text:
              credential-id: quibble-earlywarningbot-api-key
              variable: QUIBBLE_API_KEY

# Super basic sense check for integration/composer repo
- job:
    name: 'integration-composer-check-php74-docker'
    node: Docker
    triggers:
     - zuul
    builders:
     - docker-src-dir
     - docker-ci-src-setup-simple
     - docker-run-with-log-cache-src:
         image: 'docker-registry.wikimedia.org/releng/php74:0.5.1'
         args: '/src/vendor/bin/composer --version'
    publishers:
     - docker-cleanup

- job:
    name: integration-config-qa
    node: Docker
    concurrent: false
    triggers:
     - timed: '0 3 * * *'
    scm:
     - git:
         url: 'https://gerrit.wikimedia.org/r/p/integration/config.git'
         branches:
             - master
    parameters:
        - string:
            name: 'ZUUL_URL'
            default: 'https://gerrit.wikimedia.org/r/p'
        - string:
            name: 'ZUUL_PROJECT'
            default: 'integration/config'
        - string:
            name: 'ZUUL_REF'
            default: 'master'
    builders:
     - docker-cache-dir
     - docker-log-dir
     - docker-src-dir
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/tox-buster:4.8.0-1
         args: '-e qa -- --xunit-file=/log/junit-qa.xml'
    publishers:
     - archive-log-dir
     - xunit:
         types:
             - phpunit:
                 pattern: 'log/junit*.xml'
     - docker-cleanup

- project:
    name: 'integration-config'
    jobs:
     - '{name}-tox-docker':
         build_timeout: 5
     - 'integration-config-{command}-docker':
         command:
             - jjb-diff:
                 entrypoint: utils/jjb-diff.sh
             - shellcheck:
                 entrypoint: utils/shellcheck.sh
             - zuul-layout-diff:
                 timeout: 3  # minutes
                 entrypoint: utils/zuul-layout-diff.sh
             - zuul-layout-validate:
                 timeout: 3  # minutes
                 entrypoint: utils/zuul-layout-validate.sh

- project:
    name: 'integration-pipelinelib'
    jobs:
     - '{name}-docker-doc-publish':
         image: docker-registry.wikimedia.org/releng/gradle:4.4.1
         args: 'groovydoc'
         docsrc: 'src/build/docs/groovydoc'
         docdest: 'pipelinelib'

- job-template:
    name: 'integration-quibble-fullrun-{type}'
    node: Docker
    triggers:
      - zuul
    builders:
      - setup
      - docker-run-with-log-cache-src:
          image: docker-registry.wikimedia.org/releng/quibble-buster-php74:1.5.6-s2
          entrypoint: bash
          args: '{quibble_args}'
          workdir: /src
          options: --tmpfs /workspace/db:size=320M
          volumes:
              /srv/git: /srv/git:ro
          logdir: '/workspace/log'
    wrappers:
      - timeout:
          timeout: 45
          fail: true
      - timestamps
      - credentials-binding:
          - text:
              credential-id: composer-github-oauthtoken
              variable: COMPOSER_GITHUB_OAUTHTOKEN
          - text:
              credential-id: quibble-earlywarningbot-api-key
              variable: QUIBBLE_API_KEY
    publishers:
      - compress-mw-debug-logs
      - archive-log-allow-empty
      - teardown

- project:
    name: 'integration-gear'
    jobs:
        - '{name}-tox-docker'

- project:
    name: gearman-java
    jobs:
        - '{name}-maven-java8-docker':
            docker_image_var: docker-registry.wikimedia.org/releng/gearman-java8:1.1.0
            maven_path: '/run-with-gearmand.sh'
            timeout: 15  # minutes
        - '{name}-maven-java11-docker':
            docker_image_var: docker-registry.wikimedia.org/releng/gearman-java11:1.0.0-s1
            maven_path: '/run-with-gearmand.sh'
            timeout: 15  # minutes

- project:
    name: 'integration-quibble'
    jobs:
        - '{name}-tox-docker':
            docker_image_var: docker-registry.wikimedia.org/releng/tox-buster:4.8.0-1
        - '{name}-tox-publish':
            docker_image_var: docker-registry.wikimedia.org/releng/tox-buster:4.8.0-1
            docsrc: 'doc/build/html'
            docdest: 'quibble'
        - 'integration-quibble-fullrun-{type}':
            type:
                - defaults:
                    quibble_args: >-
                        -c '/usr/bin/supervisord -c /etc/supervisor/supervisord.conf
                        && /src/utils/ci-fullrun.sh
                        --color
                        --db-dir /workspace/db
                        --web-backend=external --web-url=http://127.0.0.1:9413'
                - sqlite:
                    quibble_args: >-
                        -c '/usr/bin/supervisord -c /etc/supervisor/supervisord.conf
                        && /src/utils/ci-fullrun.sh
                        --color
                        --db-dir /workspace/db
                        --db sqlite
                        --skip api-testing
                        --web-backend=external --web-url=http://127.0.0.1:9413'
                - extensions:
                    quibble_args: >-
                        -c '/usr/bin/supervisord -c /etc/supervisor/supervisord.conf
                        && /src/utils/ci-fullrun-extensions.sh
                        --color
                        --db-dir /workspace/db
                        --skip phpunit,selenium,npm-test,qunit,api-testing
                        --web-backend=external --web-url=http://127.0.0.1:9413'
                - extensions-phpunit:
                    quibble_args: >-
                        -c '/usr/bin/supervisord -c /etc/supervisor/supervisord.conf
                        && /src/utils/ci-fullrun-extensions.sh
                        --color
                        --db-dir /workspace/db
                        --run phpunit
                        --skip selenium,npm-test,qunit,api-testing
                        --web-backend=external --web-url=http://127.0.0.1:9413'

- project:
    name: jenkins-plugin
    project:
        - gearman
    jobs:
        - '{name}-{project}-maven-java8-docker'
        - '{name}-{project}-maven-java11-docker'

- project:
    name: 'integration-zuul'
    jobs:
     - '{name}-tox-docker':
         build_timeout: 5

- job-template:
    name: 'integration-zuul-deploy-{python}-{distribution}'
    node: Docker
    triggers:
        - zuul
    builders:
        - docker-wipe-dir:
            dir: wheels-cache
        - docker-log-dir
        - docker-src-dir
        - docker-ci-src-setup-simple
        - shell: 'tar --directory wheels-cache -xzvf src/artifacts/artifacts.{distribution}.tar.gz'
        - shell: |
            set -euxo pipefail
            tar -tzf src/artifacts/artifacts.{distribution}.tar.gz|sort > log/{distribution}-old.txt
        - shell: 'docker pull {image}'  # update latest tag

        # python-pbr inspects the git directory to forge the application
        # version (based on `git describe`).
        #
        # `src` is a git submodule, `.git` is a file which contains a relative
        # link to the submodule git directory in the parent (deploy)
        # repository. It is thus not accessible and pbr is unable to determine
        # the git repository which leads to a failure.
        #
        # The following does the opposite of `git submodule absorbgitdirs`
        # moving the git directory from the deploy repo back to the submodule
        # src. The python-build images would have to use a similar trick or act
        # on the whole deploy repo rather than just the source one.
        - docker-run:
            image: '{image}'
            options: --user=nobody
            entrypoint: rm
            args: /deploy/src/.git
            volumes:
                src: /deploy
        - docker-run:
            image: '{image}'
            options: --user=nobody
            entrypoint: git
            args: -C /deploy/src --work-tree=/deploy/src config --unset core.worktree
            volumes:
                src: /deploy
                src/.git/modules/src: /deploy/src/.git

        # Invoke the python build image
        - docker-run:
            image: '{image}'
            options: --user=nobody
            entrypoint: /bin/bash
            args: -x /bin/run.sh
            volumes:
                src: /deploy
                src/.git/modules/src: /deploy/src/.git
                log: /wheels
                wheels-cache: /wheels-cache
            environment:
                PIP_FIND_LINKS: /wheels-cache
                PYTHON_SUFFIX: '{python-suffix}'
        # Show diffs of artifacts content. Based on integration/zuul/deploy Makefile
        - shell: |
            set -euxo pipefail
            tar -tzf log/artifacts.tar.gz \
                |sort > log/{distribution}-new.txt
            diff --unified=0 --color=always \
                log/{distribution}-old.txt \
                log/{distribution}-new.txt \
                || ([ $? -le 1 ] && exit 0) || exit $?
        # No need to collect the tarball
        - shell: rm -f artifacts.tar.gz
    publishers:
        - castor-save-workspace-cache
        - archive-log-dir
        - docker-cleanup

- project:
    name: 'integration-zuul-deploy'
    # Images are set to latest and maintained by SRE
    python:
        - python3:
            python-suffix: 3
        - python2:
            python-suffix: 2
    distribution:
        - bullseye
        - buster
    jobs:
        - 'integration-zuul-deploy-{python}-{distribution}':
            image: 'docker-registry.wikimedia.org/{python}-build-{distribution}:latest'
