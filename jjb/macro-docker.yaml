# Stop and/or kill any containers still running for the build.
- publisher:
    name: docker-reap-containers
    publishers:
     - postbuildscript:
         builders:
          - build-on:
              - SUCCESS
              - UNSTABLE
              - FAILURE
              - ABORTED
            build-steps:
              - shell: |
                  set -euxo pipefail
                  docker ps -q \
                    --filter label=jenkins.job=$JOB_NAME \
                    --filter label=jenkins.build=$BUILD_NUMBER \
                    | xargs --no-run-if-empty docker stop

# Delete everything in $WORKSPACE.
# publisher for all Docker based jobs.
- publisher:
    name: docker-wipe-workspace
    publishers:
     # Run via Docker as root to have sufficient permission to delete files of
     # any owner within the workspace directory and use `find` which more
     # handily processes dotfiles. Then delete the workspace directory itself.
     - postbuildscript:
         builders:
          - build-on:
              - SUCCESS
              - UNSTABLE
              - FAILURE
              - ABORTED
            build-steps:
              - docker-run:
                 image: 'docker-registry.wikimedia.org/buster:latest'
                 options: >-
                   --user=root
                   --entrypoint=/usr/bin/find
                   --volume "$WORKSPACE":/workspace
                 args: >-
                   "/workspace" -mindepth 1 -delete
              - shell: |
                 set -u
                 rmdir "$WORKSPACE"

# Perform all cleanup operations for a Docker build. This should generally be
# used as the final publisher for all Docker based jobs.
- publisher:
    name: docker-cleanup
    publishers:
      - docker-reap-containers
      - docker-wipe-workspace

# Create a cache directory that will be
# mounted into a container with --volume
- builder:
    name: docker-cache-dir
    builders:
     - shell: |
        mkdir -m 2777 -p "cache"

# Create a log directory that will be
# mounted into a container with --volume
- builder:
    name: docker-log-dir
    builders:
     - docker-wipe-dir:
         dir: log

# Create a src directory that will be
# mounted into a container with --volume
- builder:
    name: docker-src-dir
    builders:
     - docker-wipe-dir:
         dir: src

# Delete content of a directory under $WORKSPACE as 'nobody'
- builder:
    name: docker-wipe-dir
    builders:
     - shell: |
         set -eux
         mkdir -m 2777 -p "{dir}"
     - docker-run:
        image: 'docker-registry.wikimedia.org/buster:latest'
        options: >-
          --user=nobody
          --entrypoint=/usr/bin/find
          --volume "$WORKSPACE":/workspace
        args: >-
          "/workspace/{dir}" -mindepth 1 -delete

# Run a Docker container using `docker run`. This builder should be used
# wherever possible to ensure the proper common arguments that allow for
# correct signal passing and cleanup are passed.
- builder:
    name: docker-run
    builders:
     - shell: |
        #!/bin/bash
        set -eux
        set -o pipefail
        exec docker run {obj:options|} \
          --security-opt seccomp=unconfined \
          --init \
          --rm \
          --label "jenkins.job=$JOB_NAME" \
          --label "jenkins.build=$BUILD_NUMBER" \
          --env-file <(/usr/bin/env|egrep -v '^(HOME|SHELL|PATH|LOGNAME|MAIL)=') \
          '{image}' {obj:args|}
        # nothing else can be executed due to exec

# Run a docker image with cache, log, and src directories
#
# Parameter:
#
# image: the Docker image to run (eg: releng/php)
# args (optional): arguments passed to `docker run`.
- builder:
    name: docker-run-with-log-cache-src
    builders:
     - shell: |
        #!/bin/bash -eu
        set -x
        chmod 2777 src
     - docker-run:
        options: >-
          {obj:options|}
          --volume "$(pwd)"/src:{obj:srcdir|/src}
          --volume "$(pwd)"/cache:/cache
          --volume "$(pwd)"/log:{obj:logdir|/log}
        image: '{obj:image}'
        args: '{obj:args|}'

# Use a docker image to clone the repository into /src with explicit options.
#
# Parameters:
#
# submodules (bool): whether or not to update/initialize repo submodules
#
- builder:
    name: docker-ci-src-setup-simple
    builders:
     - docker-run: !j2-yaml: >-
         options:
           --volume "$(pwd)"/src:/src
           --volume "$(pwd)"/cache:/cache
           --volume /srv/git:/srv/git:ro
           {%- if submodules is defined and not submodules %}
           --env GIT_NO_SUBMODULES=yes
           {%- endif %}
         image: 'docker-registry.wikimedia.org/releng/ci-src-setup-simple:0.4.2-s1'

- builder:
    name: docker-zuul-cloner
    builders:
     - docker-src-dir
     - docker-run:
        options: >-
          --volume "$(pwd)"/src:/src
          --volume /srv/git:/srv/git:ro
        image: 'docker-registry.wikimedia.org/releng/zuul-cloner:0.2.1-s5'
        args: >-
          --color --verbose
          --map /zuul-clonemap.yaml
          --workspace /src
          --cache-dir /srv/git
          https://gerrit.wikimedia.org/r/p
          {projects}
