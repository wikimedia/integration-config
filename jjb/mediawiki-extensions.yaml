# Publishing workspace/docs to doc.wikimedia.org/:DOC_PROJECT/:DOC_SUBPATH/php/
# - DOC_PROJECT: determined in parameter_functions.py (mw extension name)
# - DOC_SUBPATH: determined in parameter_functions.py (branch or tag)
- job:
    name: 'mwext-doxygen-publish'
    node: Docker
    concurrent: false
    triggers:
     - zuul
    builders:
     - docker-log-dir
     - docker-src-dir
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/doxygen:1.0.0
     - doc-publish:
        docsrc: 'src/docs/php'
        docdest: '$DOC_PROJECT/$DOC_SUBPATH/php'
    publishers:
     - archive-log-allow-empty
     - docker-cleanup

- job:
    name: 'mediawiki-i18n-check-docker'
    node: Docker
    concurrent: true
    triggers:
     - zuul
    builders:
     - docker-src-dir
     - docker-ci-src-setup-simple
     # It's not really worth creating a docker image for this pretty
     # "simple" bash script
     - shell: |
        #!/bin/bash
        set -uxo pipefail
        cd src

        # Assumption: Any messages containing literal js will end in .js. Any other
        # raw html message is in normal html context (not attribute)

        git show FETCH_HEAD -U0 | grep '^+' | sed -E -e 's/<\/? ?(abbr|span|br|strong|em|pre|nowiki|charinsert|b|del|code|kbd|p|tt|div|i|big|sup|sub|samp|var|small|h1|h2|h3|h4|u|ol|ul|li|mark|user|page|hr|templatestyles|NDL|math|syntaxhighlight|templatedata|pagelist|bdi|ref|dd|dl)( ((class|title|lang|xml:lang|dir|xmlns|display|alttext)=\\?["'\''][^=<>"'\'']*\\?["'\'']))* ?\/?>//g' -e 's/<!--//g' -e 's/<https?:\/\/[a-zA-Z0-9./-]*>//g' | grep '<'
        if [[ $? == 0 ]]; then
          echo "HTML detected. Manual review required"
          exit 1
        else
          echo 'ok'
        fi

        git show FETCH_HEAD -U0 | grep '^+' | sed -E -e 's/\\\\//g' -e 's/\\[nt"]//g' | grep '\\'
        if [[ $? == 0 ]]; then
          echo "JSON escape sequence detected. Manual review required"
          exit 1
        else
          echo 'ok'
        fi

        exit 0
    publishers:
     - docker-cleanup

# Phan! (T153039)
- job-template:
    name: '{thing}-{php}-phan-docker'
    node: Docker
    properties:
     - build-discarder:
         days-to-keep: 15
    triggers:
     - zuul
    builders:
     - docker-castor-load
     - docker-log-dir
     - docker-src-dir

     # Prepare the sources using Quibble.
     # Notably run composer update in the thing to install mediawiki/phan-config.
     - docker-run-with-log-cache-src:
         image: '{setup_image}'
         options: >-
             --tmpfs /workspace/db:size=320M
         volumes:
             /srv/git: /srv/git:ro
         # Use vendor and skip-deps
         # We do not want to bring in MediaWiki core dev dependencies (T223397)
         #
         # MediaWiki installation is skipped, we do not need it. Additionally
         # we only inject the extension dependencies required by Phan, notably
         # we do not install dependencies of dependencies which might end up
         # breaking the installation due to a missing extension.json
         # requirement. (T232413)
         args: >
             --git-parallel=8
             --packages-source=vendor
             --db=mysql --db-dir=/workspace/db
             --skip-deps
             --skip-install
             --skip=all
         logdir: '/workspace/log'
         srcdir: '/workspace/src'
     # Install the extension/skin composer dev dependencies to bring in phan config
     - docker-run-with-log-cache-src:
        image: '{composer_image}'
        args: '--working-dir=/src/"$THING_SUBNAME" update --ansi --no-progress --prefer-dist --profile'

     # Now run Phan
     - docker-run-with-log-cache-src:
        environment:
            PHAN_COLOR_SCHEME: light
        image: '{phan_image}'
        args: '--color'
        srcdir: '/mediawiki'

    publishers:
     - castor-save-workspace-cache
     - docker-cleanup

- project:
    name: phan-jobs
    thing:
        - mwext
        - mwskin
    php:
        - php72:
            setup_image: docker-registry.wikimedia.org/releng/quibble-buster-php72:1.4.5-s2
            composer_image: docker-registry.wikimedia.org/releng/composer-php72:0.5.0-s7
            phan_image: docker-registry.wikimedia.org/releng/mediawiki-phan:0.9.0-s7
        - php73:
            setup_image: docker-registry.wikimedia.org/releng/quibble-buster-php73:1.4.5-s1
            composer_image: docker-registry.wikimedia.org/releng/composer-php73:0.4.0-s3
            phan_image: docker-registry.wikimedia.org/releng/mediawiki-phan-php73:0.3.1-s3
        - php74:
            setup_image: docker-registry.wikimedia.org/releng/quibble-buster-php74:1.4.5-s1
            composer_image: docker-registry.wikimedia.org/releng/composer-php74:0.2.0-s9
            phan_image: docker-registry.wikimedia.org/releng/mediawiki-phan-php74:0.2.1-s3
        - php80:
            setup_image: docker-registry.wikimedia.org/releng/quibble-buster-php80:1.4.5-s1
            composer_image: docker-registry.wikimedia.org/releng/composer-php80:0.0.2-s10
            phan_image: docker-registry.wikimedia.org/releng/mediawiki-phan-php80:0.1.2-s3
        - php81:
            setup_image: docker-registry.wikimedia.org/releng/quibble-buster-php81:1.4.5-s1
            composer_image: docker-registry.wikimedia.org/releng/composer-php81:0.0.1-s3
            phan_image: docker-registry.wikimedia.org/releng/mediawiki-phan-php81:0.0.2-s3
    jobs:
        - '{thing}-{php}-phan-docker'

- project:
    name: wdio-selenium-daily
    project:
        - AdvancedSearch:
            recipients: qa-alerts@lists.wikimedia.org techwish-devs@wikimedia.de # @WMDE-Fisch
            repository: mediawiki/extensions/AdvancedSearch
            site: en.wikipedia
        - CentralNotice:
            recipients: fr-tech@wikimedia.org jbolorinos-ctr@wikimedia.org qa-alerts@lists.wikimedia.org # fundraising-backlog @jbolorinos-ctr
            repository: mediawiki/extensions/CentralNotice
            site: en.wikipedia
        - CirrusSearch:
            recipients: discovery-alerts@lists.wikimedia.org qa-alerts@lists.wikimedia.org # @dcausse @EBernhardson
            repository: mediawiki/extensions/CirrusSearch
            site: en.wikipedia
        - Echo:
            recipients: etonkovidova@wikimedia.org qa-alerts@lists.wikimedia.org thinkcolorful@thinkcolorful.org # @Etonkovidova @Ephemeralwaves
            repository: mediawiki/extensions/Echo
            site: en.wikipedia
        - Math:
            recipients: qa-alerts@lists.wikimedia.org wiki@physikerwelt.de # @Physikerwelt
            repository: mediawiki/extensions/Math
            site: en.wikipedia
        - Minerva:
            recipients: proticom-ctr@wikimedia.org qa-alerts@lists.wikimedia.org # @Edtadros
            repository: mediawiki/skins/MinervaNeue
            site: en.wikipedia
        - MobileFrontend:
            recipients: jrobson@wikimedia.org qa-alerts@lists.wikimedia.org # @Jdlrobson
            repository: mediawiki/extensions/MobileFrontend
            site: en.wikipedia
        - Newsletter:
            recipients: qa-alerts@lists.wikimedia.org 01tonythomas@gmail.com # @01tonythomas
            repository: mediawiki/extensions/Newsletter
            site: en.wikipedia
        - Popups:
            recipients: jrobson@wikimedia.org qa-alerts@lists.wikimedia.org samsmith@wikimedia.org # @Jdlrobson @phuedx
            repository: mediawiki/extensions/Popups
            site: en.wikipedia
        - RelatedArticles:
            recipients: qa-alerts@lists.wikimedia.org samsmith@wikimedia.org discovery-alerts@lists.wikimedia.org # @phuedx
            repository: mediawiki/extensions/RelatedArticles
            site: en.wikipedia
        - TwoColConflict:
            recipients: qa-alerts@lists.wikimedia.org techwish-devs@wikimedia.de # @awight TCB-Team
            repository: mediawiki/extensions/TwoColConflict
            site: en.wikipedia
        - Vector:
            recipients: qa-alerts@lists.wikimedia.org # @Edtadros
            repository: mediawiki/skins/Vector
            site: en.wikipedia
        - VisualEditor:
            recipients: eakinloose@wikimedia.org qa-alerts@lists.wikimedia.org # @EAkinloose
            repository: mediawiki/extensions/VisualEditor
            site: en.wikipedia
        - WikibaseLexeme:
            recipients: qa-alerts@lists.wikimedia.org wikidata-ci-status@wikimedia.de # wikidata
            repository: mediawiki/extensions/WikibaseLexeme
            site: wikidata
    jobs:
        - 'selenium-daily-{sitename}-{project}':
            sitename:
                - beta:
                    mw_server: 'https://en.wikipedia.beta.wmflabs.org'
